<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">

<link rel="import" href="elements/am-logo.html">
<link rel="import" href="elements/am-nav.html">
<link rel="import" href="elements/am-pages.html">
<link rel="import" href="theme/am-icons.html">
<link rel="import" href="theme/colors.html">
<link rel="import" href="theme/shared-styles.html">

<dom-module id="am-app">
  <template>
    <style include="colors shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        overflow: hidden;

        --am-logo-sizing: 16px;
      }
      #header {
        flex: 0 0 auto;
        display: flex;
        justify-content: flex-start;
        color: var(--text-color);
        padding-left: var(--padding);
        padding-right: var(--padding);
        margin-left: var(--gutter);
        margin-right: var(--gutter);
      }
      #title {
        overflow: hidden;
        margin-top: var(--am-logo-sizing);
        margin-bottom: var(--am-logo-sizing);
      }
      #nav {
        margin-bottom: -1px;
      }
      #content, #nav {
        flex: 1 1 auto;
      }
      #content {
        overflow-y: auto;
      }
    </style>

    <firebase-app
      auth-domain="portfolio-138c8.firebaseapp.com"
      database-url="https://portfolio-138c8.firebaseio.com"
      api-key="AIzaSyCjMz2srT0HjuJRPH2ThhLD7XqLcrYqSQQ"
      storage-bucket="portfolio-138c8.appspot.com"
      messaging-sender-id="807153287758"
    ></firebase-app>

    <div id="header" class="divider">
      <a id="title"
        href="/">
        <am-logo></am-logo>
      </a>
      <am-nav id="nav"
        page="{{page}}"
        pages="[[pages]]"
        root-path="[[rootPath]]"
      ></am-nav>
    </div>
    <div id="content">
      <am-pages
        page="{{page}}"
        pages="{{pages}}"
        root-path="[[rootPath]]"
      ></am-pages>
    </div>
  </template>

  <script>
    class AmApp extends Polymer.Element {
      static get is() {
        return 'am-app';
      }
      static get properties() {
        return {
          page: String,
          pages: Array,

          /* FIXME: This shouldn't be neccessary, but the Analyzer isn't picking up Polymer.Element#rootPath */
          rootPath: String,
        };
      }

      constructor() {
        super();

        this.closeDrawer = this.closeDrawer.bind(this);
        this.__touchMove = this.__touchMove.bind(this);
        this.__touchStart = this.__touchStart.bind(this);
      }
      connectedCallback() {
        super.connectedCallback();

        document.addEventListener('click', this.closeDrawer, false);
        document.addEventListener('touchmove', this.__touchMove, false);
        document.addEventListener('touchstart', this.__touchStart, false);
      }
      disconnectedCallback() {
        super.disconnectedCallback();

        document.removeEventListener('click', this.closeDrawer);
        document.removeEventListener('touchmove', this.__touchMove);
        document.removeEventListener('touchstart', this.__touchStart);
      }

      closeDrawer() {
        this.open = false;
        this.__xDown = null;
      }
      openDrawer() {
        this.open = true;
        this.__xDown = null;
      }
      toggleDrawer(event) {
        event.stopPropagation();
        this.open = !this.open;
      }

      __touchMove(event) {
        if (!this.__xDown) return;

        const xUp = event.touches[0].clientX;
        const xDiff = this.__xDown - xUp;

        if (xDiff > this.swipeDiff) {
          this.closeDrawer();
        } else if (xDiff < (-1 * this.swipeDiff)) {
          this.openDrawer();
        }
      }
      __touchStart(event) {
        this.__xDown = event.touches[0].clientX;
      }
      __updateGlobal(event) {
        const property = event.type.replace('-changed', '');
        const styles = {};
        let value = event.detail.value;
        switch (property) {
          case 'gutter':
            value = `${value}px`;
            break;
          default:
            value = String(value);
            break;
        }
        styles[`--${property}`] = value;
        this.updateStyles(styles);
      }
    }

    window.customElements.define(AmApp.is, AmApp);
  </script>
</dom-module>
