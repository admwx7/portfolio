<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/am-breakpoints/am-breakpoints.html">

<link rel="import" href="elements/am-logo.html">
<link rel="import" href="elements/am-nav.html">
<link rel="import" href="elements/am-pages.html">
<link rel="import" href="theme/am-icons.html">
<link rel="import" href="theme/colors.html">
<link rel="import" href="theme/shared-styles.html">

<dom-module id="am-app">
  <template>
    <style include="colors shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        height: 100vh;
        width: 100vw;

        --am-logo-sizing: var(--padding);
      }
      :host([hide-top-nav]) {
        height: 100%;
      }
      am-logo[large] {
        --am-logo-sizing: var(--gutter);
      }
      #header {
        flex: 0 0 auto;
        display: flex;
        justify-content: flex-start;
        color: var(--text-color);
        padding-left: var(--padding);
        padding-right: var(--padding);
      }
      #title[center] {
        margin-left: auto;
        margin-right: auto;
      }
      #nav {
        margin-bottom: -1px;
      }
      #content, #nav {
        flex: 1 1 auto;
      }
      #content {
        overflow-y: auto;
      }
      #drawer {
        display: block;
        position: fixed;
        top: 0;
        bottom: 0;
        left: -305px;
        width: 300px;
        z-index: 999;
        border-right: 1px solid var(--divider-color);
        box-shadow: 1px 0 2px 0 var(--divider-shadow-color);

        background-color: var(--light-primary-color);
        transition-duration: 0.75s;
        transition-property: left;
      }
      #drawer[open] {
        left: 0;
      }
      #drawer .icon {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        transition-duration: 0.75s;
        transition-property: transform;
        cursor: pointer;
        color: var(--light-primary-color);
      }
      #drawer[open] .icon {
        transform: rotateY(180deg);
      }
    </style>

    <firebase-app
      auth-domain="portfolio-138c8.firebaseapp.com"
      database-url="https://portfolio-138c8.firebaseio.com"
      api-key="AIzaSyCjMz2srT0HjuJRPH2ThhLD7XqLcrYqSQQ"
      storage-bucket="portfolio-138c8.appspot.com"
      messaging-sender-id="807153287758"
    ></firebase-app>
    <am-breakpoints
      active="{{hideTopNav}}"
      breakpoints="xsmall,small-tablet,large-tablet,medium-handset-landscape,larget-handset-landscape"
      on-columns-changed="__updateGlobal"
      on-gutter-changed="__updateGlobal"
    ></am-breakpoints>
    <am-breakpoints
      active="{{__largeLogo}}"
      breakpoints="large-tablet"
    ></am-breakpoints>

    <div id="drawer" open$="[[open]]">
      <am-nav id="side-nav"
        page="{{page}}"
        pages="[[pages]]"
        root-path="[[rootPath]]"
        vertical
      ></am-nav>
      <iron-icon class="icon"
        icon="am-icons:chevron-right"
        on-click="toggleDrawer"
      ></iron-icon>
    </div>
    <div id="header" class="divider">
      <a id="title"
        center$="[[hideTopNav]]"
        href="/">
        <am-logo
          large$="[[__largeLogo]]"
        ></am-logo>
      </a>
      <am-nav id="nav"
        hidden$="[[hideTopNav]]"
        page="{{page}}"
        pages="[[pages]]"
        root-path="[[rootPath]]"
      ></am-nav>
    </div>
    <am-pages id="content"
      page="{{page}}"
      pages="{{pages}}"
      root-path="[[rootPath]]"
    ></am-pages>
  </template>

  <script>
    Polymer.setPassiveTouchGestures(true);
    class AmApp extends Polymer.Element {
      static get is() {
        return 'am-app';
      }
      static get properties() {
        return {
          hideTopNav: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          open: {
            type: Boolean,
            notify: true,
            value: false,
          },
          page: String,
          pages: Array,
          swipeDiff: {
            type: Number,
            value: 120,
          },

          __largeLogo: {
            type: Boolean,
            value: false,
          },
          __xDown: {
            type: Number,
            value: null,
          },

          /* FIXME: This shouldn't be neccessary, but the Analyzer isn't picking up Polymer.Element#rootPath */
          rootPath: String,
        };
      }

      constructor() {
        super();

        this.closeDrawer = this.closeDrawer.bind(this);
        this.__touchMove = this.__touchMove.bind(this);
        this.__touchStart = this.__touchStart.bind(this);
      }
      connectedCallback() {
        super.connectedCallback();

        document.addEventListener('click', this.closeDrawer, false);
        document.addEventListener('touchmove', this.__touchMove, false);
        document.addEventListener('touchstart', this.__touchStart, false);
      }
      disconnectedCallback() {
        super.disconnectedCallback();

        document.removeEventListener('click', this.closeDrawer);
        document.removeEventListener('touchmove', this.__touchMove)
        document.removeEventListener('touchstart', this.__touchStart)
      }

      closeDrawer() {
        this.open = false;
        this.__xDown = null;
      }
      openDrawer() {
        this.open = true;
        this.__xDown = null;
      }
      toggleDrawer(event) {
        event.stopPropagation();
        this.open = !this.open;
      }

      __touchMove(event) {
        if (!this.__xDown) return;

        const xUp = event.touches[0].clientX;
        const xDiff = this.__xDown - xUp;

        if (xDiff > this.swipeDiff) {
          this.closeDrawer();
        } else if (xDiff < (-1 * this.swipeDiff)) {
          this.openDrawer();
        }
      }
      __touchStart(event) {
        this.__xDown = event.touches[0].clientX;
      }
      __updateGlobal(event) {
        const property = event.type.replace('-changed', '');
        const styles = {};
        let value = event.detail.value;
        switch(property) {
          case 'gutter':
            value = `${value}px`;
          default:
            styles[`--${property}`] = String(value);
            break;
        }
        this.updateStyles(styles);
      }
    }

    window.customElements.define(AmApp.is, AmApp);
  </script>
</dom-module>
