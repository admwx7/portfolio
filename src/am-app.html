<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/am-breakpoints/am-breakpoints.html">

<link rel="import" href="elements/am-logo.html">
<link rel="import" href="elements/am-nav.html">
<link rel="import" href="elements/am-pages.html">
<link rel="import" href="theme/am-icons.html">
<link rel="import" href="theme/colors.html">
<link rel="import" href="theme/shared-styles.html">

<dom-module id="am-app">
  <template>
    <style include="colors shared-styles">
      :host {
        display: flex;
        flex-direction: column;
        color: var(--text-color);
        height: 100vh;
        background: linear-gradient(150deg, var(--secondary-background-color) 1vh, var(--primary-background-color) 21vh, var(--primary-background-color) 79.75vh, var(--secondary-background-color) 80vh, var(--primary-background-color) 100vh);

        --am-logo-sizing: calc(0.75 * var(--gutter));
      }
      :host([large-logo]) {
        --am-logo-sizing: var(--gutter);
        --header-height: calc(var(--am-logo-sizing) * 5);
      }
      :host([hide-top-nav]) {
        height: 100%;

        --header-height: 0;
        --am-contact-flyouts-position: absolute;
      }
      #header {
        flex: 0 0 auto;
        display: flex;
        justify-content: flex-start;
        padding-left: var(--padding);
        padding-right: var(--padding);
        background-color: var(--primary-background-color);
        box-shadow: 0 1px 2px 0 var(--divider-shadow-color);
        z-index: 1;
      }
      #title[center] {
        margin-left: auto;
        margin-right: auto;
      }
      #nav {
        margin-bottom: -1px;
      }
      #content, #nav {
        flex: 1 1 auto;
      }
      #content {
        overflow-y: auto;
      }
      #drawer {
        display: block;
        position: fixed;
        top: 0;
        bottom: 0;
        left: -305px;
        width: 300px;
        z-index: 999;
        border-right: 1px solid var(--divider-color);
        box-shadow: 1px 0 2px 0 var(--divider-shadow-color);

        background-color: var(--primary-background-color);
        transition-duration: 0.75s;
        transition-property: left;
      }
      #drawer[open] {
        left: 0;
      }
      #drawer .icon {
        position: absolute;
        right: -25px;
        top: 50%;
        transform: translateY(-50%);
        transition-duration: 0.75s;
        transition-property: transform;
        cursor: pointer;
        color: var(--light-primary-color);
      }
      #drawer .icon:hover {
        filter:
          drop-shadow(1px 0 2px var(--accent-shadow-color))
          drop-shadow(-1px 0 2px var(--accent-shadow-color))
          drop-shadow(0 1px 2px var(--accent-shadow-color))
          drop-shadow(0 -1px 2px var(--accent-shadow-color));
      }
      #drawer[open] .icon {
        transform: rotateY(180deg);
      }
      #menuIcon {
        align-self: center;
        height: 35px;
        width: 35px;
        margin-right: -35px;
      }
    </style>

    <firebase-app
      auth-domain="portfolio-138c8.firebaseapp.com"
      database-url="https://portfolio-138c8.firebaseio.com"
      api-key="AIzaSyCjMz2srT0HjuJRPH2ThhLD7XqLcrYqSQQ"
      storage-bucket="portfolio-138c8.appspot.com"
      messaging-sender-id="807153287758"
    ></firebase-app>
    <am-breakpoints
      active="{{hideTopNav}}"
      breakpoints="xsmall,small-tablet,large-tablet,medium-handset-landscape,larget-handset-landscape"
      on-columns-changed="__updateGlobal"
      on-gutter-changed="__updateGlobal"
    ></am-breakpoints>
    <am-breakpoints
      active="{{largeLogo}}"
      breakpoints="large-tablet"
    ></am-breakpoints>

    <div id="drawer"
      open$="[[open]]">
      <am-nav id="side-nav"
        page="{{page}}"
        pages="[[pages]]"
        root-path="[[rootPath]]"
        vertical
      ></am-nav>
      <iron-icon class="icon"
        icon="am-icons:chevron-right"
        on-click="toggleDrawer"
      ></iron-icon>
    </div>
    <div id="header">
      <iron-icon id="menuIcon"
        hidden$="[[!hideTopNav]]"
        icon="am-icons:menu"
        on-click="toggleDrawer"
      ></iron-icon>
      <a id="title"
        center$="[[hideTopNav]]"
        href="/">
        <am-logo></am-logo>
      </a>
      <am-nav id="nav"
        hidden$="[[hideTopNav]]"
        page="{{page}}"
        pages="[[pages]]"
        root-path="[[rootPath]]"
      ></am-nav>
    </div>
    <am-pages id="content"
      page="{{page}}"
      pages="{{pages}}"
      root-path="[[rootPath]]"
    ></am-pages>
  </template>

  <script>
    Polymer.setPassiveTouchGestures(true);

    /**
     * `am-app` contains the app-wide structure and common functionality
     *
     * @customElement
     * @polymer
     * @extends Polymer.Element
     */
    class AmApp extends Polymer.Element {
      // eslint-disable-next-line require-jsdoc
      static get is() {
        return 'am-app';
      }
      // eslint-disable-next-line require-jsdoc
      static get properties() {
        return {
          hideTopNav: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          largeLogo: {
            type: Boolean,
            value: false,
            notify: true,
            reflectToAttribute: true,
          },
          open: {
            type: Boolean,
            notify: true,
            value: false,
          },
          page: {
            type: String,
            observer: '__pageChanged',
          },
          pages: Array,
          swipeDiff: {
            type: Number,
            value: 120,
          },

          __xDown: {
            type: Number,
            value: null,
          },

          /* FIXME: This shouldn't be neccessary, but the Analyzer isn't picking up Polymer.Element#rootPath */
          rootPath: String,
        };
      }
      /* Lifecycle Methods */
      // eslint-disable-next-line require-jsdoc
      constructor() {
        super();

        this.closeDrawer = this.closeDrawer.bind(this);
        this.__touchMove = this.__touchMove.bind(this);
        this.__touchStart = this.__touchStart.bind(this);
      }
      // eslint-disable-next-line require-jsdoc
      connectedCallback() {
        super.connectedCallback();

        document.addEventListener('click', this.closeDrawer, false);
        document.addEventListener('touchmove', this.__touchMove, false);
        document.addEventListener('touchstart', this.__touchStart, false);
      }
      // eslint-disable-next-line require-jsdoc
      disconnectedCallback() {
        super.disconnectedCallback();

        document.removeEventListener('click', this.closeDrawer);
        document.removeEventListener('touchmove', this.__touchMove);
        document.removeEventListener('touchstart', this.__touchStart);
      }
      /* Public Methods */
      /**
       * Closes the drawer
       */
      closeDrawer() {
        this.open = false;
        this.__xDown = null;
      }
      /**
       * Opens the drawer
       */
      openDrawer() {
        this.open = true;
        this.__xDown = null;
      }
      /**
       * Toggles the drawer and prevents event propagation
       *
       * @param {CustomEvent} event
       */
      toggleDrawer(event) {
        event.stopPropagation();
        this.open = !this.open;
      }
      /* Private Methods */
      /**
       * Forces navigation closed every time there's a page change
       */
      __pageChanged() {
        this.open = false;
      }
      /**
       * Monitors movements associated with touch actions for triggering between open and closing the drawer
       * @private
       *
       * @param {CustomEvent} event
       */
      __touchMove(event) {
        if (!this.__xDown) return;

        const xUp = event.touches[0].clientX;
        const xDiff = this.__xDown - xUp;

        if (xDiff > this.swipeDiff) {
          this.closeDrawer();
        } else if (xDiff < (-1 * this.swipeDiff)) {
          this.openDrawer();
        }
      }
      /**
       * Tracks touch start for opening / closing the left drawer
       * @private
       *
       * @param {CustomEvent} event
       */
      __touchStart(event) {
        this.__xDown = event.touches[0].clientX;
      }
      /**
       * Used to trigger updates to global style variables based on event changes
       * @private
       *
       * @param {CustomEvent} event
       */
      __updateGlobal(event) {
        const property = event.type.replace('-changed', '');
        const styles = {};
        let value = event.detail.value;
        switch (property) {
          case 'gutter':
            value = `${value}px`;
            break;
          default:
            value = String(value);
            break;
        }
        styles[`--${property}`] = value;
        this.updateStyles(styles);
      }
    }

    window.customElements.define(AmApp.is, AmApp);
  </script>
</dom-module>
