<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/lazy-imports/lazy-imports-mixin.html">

<link rel="import" href="am-roles.html">

<dom-module id="am-pages">
  <link rel="lazy-import" group="blog" href="../pages/am-page-blog.html">
  <link rel="lazy-import" group="goals" href="../pages/am-page-goals.html">
  <link rel="lazy-import" group="home" href="../pages/am-page-main.html">
  <link rel="lazy-import" group="404" href="../pages/am-page-404.html">

  <template>
    <style>
      :host {
        display: block;
        position: relative;
        padding-top: calc(var(--gutter) / 2);
        overflow-x: hidden;
      }
      .page {
        display: block;
      }
    </style>

    <app-location
      route="{{__route}}"
      url-space-regex="^[[rootPath]]"
    ></app-location>
    <app-route
      data="{{__routeData}}"
      pattern="[[rootPath]]:page"
      route="{{__route}}"
      tail="{{__subRoute}}"
    ></app-route>
    <am-roles
      active="{{__isAdmin}}"
      role="admin"
    ></am-roles>
    <am-roles
      active="{{__isAlpha}}"
      role="alpha"
    ></am-roles>

    <iron-pages
      attr-for-selected="name"
      items="{{pages}}"
      role="main"
      selected="[[page]]"
      selected-attribute="active">
      <am-page-main name="home"
        class="page"
        domains="home"
        label="Home"
        root-path="[[rootPath]]"
      ></am-page-main>
      <dom-if if="[[__isAlpha]]">
        <template>
          <am-page-goals name="goals"
            class="page"
            domains="home goals"
            label="GoalTracker"
            root-path="[[rootPath]]"
            route="{{__subRoute}}"
          ></am-page-goals>
        </template>
      </dom-if>
      <dom-if if="[[__isAdmin]]">
        <template>
          <am-page-blog name="blog"
            class="page"
            domains="home blog"
            label="Blog"
            root-path="[[rootPath]]"
            route="{{__subRoute}}"
          ></am-page-blog>
        </template>
      </dom-if>
      <am-page-404 name="404"
        class="page"
        title="404"
        root-path="[[rootPath]]"
      ></am-page-404>
    </iron-pages>
  </template>
  <script>
    /**
     * `am-pages` an element for coordinating and lazy-loading pages, also builds out the information needed ot build
     *  navigation links
     *
     * @customElement
     * @polymer
     * @extends Polymer.Element
     */
    class AmPages extends Polymer.LazyImportsMixin(Polymer.Element) {
      // eslint-disable-next-line require-jsdoc
      static get is() {
        return 'am-pages';
      }
      // eslint-disable-next-line require-jsdoc
      static get properties() {
        return {
          /* The currently selected page */
          page: {
            type: String,
            notify: true,
            observer: '__pageChanged',
          },
          /* The pages available in the app */
          pages: {
            type: Array,
            notify: true,
          },
          /* Used for hosting partials of this app on a subDomain */
          subDomain: {
            type: String,
            notify: true,
            readOnly: true,
          },

          __isAdmin: {
            type: Boolean,
            value: false,
          },
          __isAlpha: {
            type: Boolean,
            value: false,
          },
          __route: Object,
          __routeData: Object,
          __subRoute: String,

          /* FIXME: This shouldn't be neccessary, but the Analyzer isn't picking up Polymer.Element#rootPath */
          rootPath: String,
        };
      }
      // eslint-disable-next-line require-jsdoc
      static get observers() {
        return [
          '__routePageChanged(__routeData.page)',
        ];
      }
      /* Lifecycle Methods */
      // eslint-disable-next-line require-jsdoc
      constructor() {
        super();

        const isLocal = Boolean(window.location.host.includes('127.0.0.1'));
        const hostParts = window.location.host.split('.');
        // "home" is considered the default subDomain
        this._setSubDomain((isLocal || hostParts.length <= 2) ? 'home' : hostParts[0]);

        this._showPage = this._showPage.bind(this);
      }
      /* Protected Methods */
      /**
       * Checks to see if the subDomain is in the list of domains this page should be
       *  displayed for.
       * @protected
       *
       * @param {String} domains
       * @param {String} [subDomain = this.subDomain]
       * @return {Boolean}
       */
      _showPage(domains, subDomain = this.subDomain) {
        domains = (domains || '').replace(' ', ',').split(',');
        return domains.includes(subDomain);
      }
      /* Private Methods */
      /**
       * Called when the page changes to make sure page and routeData.page are in sync
       * @private
       *
       * @param {String} page
       */
      __pageChanged(page) {
        if (page !== this.__routeData.page) {
          this.set('__routeData.page', page);
        }
      }
      /**
       * Attempt to route to the page, on failure send the user to the 404 page.  If there is no page defined route to
       *  the home page.
       * @private
       *
       * @param {String} page
       */
      __routePageChanged(page) {
        // fallback to the subDomain if a page isn't provided
        page = page || this.subDomain;

        // ensure the page exists in the DOM
        const el = this.shadowRoot.querySelector(`[name="${page}"]`);
        const domains = el ? el.getAttribute('domains') : '';
        const show = el &&
          (!domains || this._showPage(domains));

        if (!show) {
          this.__show404Page();
          return;
        }

        // attempt to lazy-import the page reference
        this.importLazyGroup(page).
          // assign the page so it gets displayed upon success
          then(() => {
            this.set('page', page);
            document.title = 'Austin Murdock';

            const title = el.getAttribute('title') || el.getAttribute('label');
            if (title) {
              document.title += ` | ${title}`;
            }
          }).
          // send the user to the 404 page upon failure
          catch(this.__show404Page.bind(this));
      }
      /**
       * Routes to the 404 page
       * @private
       */
      __show404Page() {
        this.set('__routeData.page', '404');
      }
    }

    window.customElements.define(AmPages.is, AmPages);
  </script>
</dom-module>
